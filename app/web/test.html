<!-- test.html - æµ‹è¯•é¡µé¢ --> 
<!-- ç”¨äºåŠŸèƒ½æµ‹è¯•å’Œè°ƒè¯•çš„é¡µé¢ --> 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Spellbook - ç³»ç»Ÿæµ‹è¯•</title>
    <script type="importmap">
    {
        "imports": {
            "@lazycatcloud/minidb": "https://cdn.skypack.dev/@lazycatcloud/minidb"
        }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00aabb;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            color: #00aabb;
            margin-bottom: 15px;
            border-bottom: 2px solid #00aabb;
            padding-bottom: 5px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        button {
            background: #00aabb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #008899;
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .success {
            background: #28a745;
        }
        
        .error {
            background: #dc3545;
        }
        
        .warning {
            background: #ffc107;
            color: #000;
        }
        
        .test-result {
            background: #333;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }
        .status-unknown { background: #6c757d; }
        
        input, textarea {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            margin: 5px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .cleanup-section {
            background: #3a1a1a;
            border: 2px solid #dc3545;
        }
        
        .cleanup-section h2 {
            color: #dc3545;
            border-bottom-color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ± AI Spellbook ç³»ç»Ÿæµ‹è¯•</h1>
        
        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="test-section">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h2>
            <div class="test-controls">
                <button onclick="checkSystemHealth()">æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€</button>
                <button onclick="checkDirectories()">æ£€æŸ¥ç›®å½•ç»“æ„</button>
            </div>
            <div id="system-status">
                <p><span class="status-indicator status-unknown"></span>åç«¯APIè¿æ¥: æœªæ£€æŸ¥</p>
                <p><span class="status-indicator status-unknown"></span>MiniDBè¿æ¥: æœªæ£€æŸ¥</p>
                <p><span class="status-indicator status-unknown"></span>æ–‡ä»¶ç³»ç»Ÿ: æœªæ£€æŸ¥</p>
            </div>
            <div class="test-result" id="system-result"></div>
        </div>
        
        <!-- åç«¯APIæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ”Œ åç«¯APIæµ‹è¯•</h2>
            <div class="test-controls">
                <button onclick="testBackendHealth()">å¥åº·æ£€æŸ¥</button>
                <button onclick="testInitData()">è·å–åˆå§‹åŒ–æ•°æ®</button>
                <button onclick="testSettings()">æµ‹è¯•è®¾ç½®æ¥å£</button>
            </div>
            <div class="test-result" id="api-result"></div>
        </div>
        
        <!-- æ–‡ä»¶å­˜å‚¨æµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ“ æ–‡ä»¶å­˜å‚¨æµ‹è¯•</h2>
            <div class="input-group">
                <input type="text" id="test-filename" placeholder="æµ‹è¯•æ–‡ä»¶å" value="storage_test">
                <input type="text" id="test-content" placeholder="æµ‹è¯•å†…å®¹" value="Hello AI Spellbook!">
            </div>
            <div class="test-controls">
                <button onclick="testFileWrite()">å†™å…¥æ–‡ä»¶</button>
                <button onclick="testFileRead()">è¯»å–æ–‡ä»¶</button>
                <button onclick="testDataSave()">ä¿å­˜JSONæ•°æ®</button>
                <button onclick="testDataLoad()">åŠ è½½JSONæ•°æ®</button>
            </div>
            <div class="test-result" id="file-result"></div>
        </div>
        
        <!-- MiniDBæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ—„ï¸ MiniDBæ•°æ®åº“æµ‹è¯•</h2>
            <div class="test-controls">
                <button onclick="testMiniDBConnection()">è¿æ¥æµ‹è¯•</button>
                <button onclick="testMiniDBOperations()">åŸºç¡€æ“ä½œæµ‹è¯•</button>
                <button onclick="testDataInitialization()">æ•°æ®åˆå§‹åŒ–æµ‹è¯•</button>
                <button onclick="testMiniDBQueries()">æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•</button>
            </div>
            <div class="test-result" id="minidb-result"></div>
        </div>
        
        <!-- è®¾ç½®ç®¡ç†æµ‹è¯• -->
        <div class="test-section">
            <h2>âš™ï¸ è®¾ç½®ç®¡ç†æµ‹è¯•</h2>
            <div class="input-group">
                <input type="text" id="setting-key" placeholder="è®¾ç½®é”®" value="testSetting">
                <input type="text" id="setting-value" placeholder="è®¾ç½®å€¼" value="testValue">
            </div>
            <div class="test-controls">
                <button onclick="testSettingsRead()">è¯»å–è®¾ç½®</button>
                <button onclick="testSettingsWrite()">å†™å…¥è®¾ç½®</button>
                <button onclick="testSettingsUpdate()">æ›´æ–°è®¾ç½®</button>
            </div>
            <div class="test-result" id="settings-result"></div>
        </div>
        
        <!-- ç»¼åˆæµ‹è¯• -->
        <div class="test-section">
            <h2>ğŸ§ª ç»¼åˆåŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-controls">
                <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                <button onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
                <button onclick="generateTestReport()">ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š</button>
            </div>
            <div class="test-result" id="comprehensive-result"></div>
        </div>
        
        <!-- æ¸…ç†æµ‹è¯•æ•°æ® -->
        <div class="test-section cleanup-section">
            <h2>ğŸ§¹ æ¸…ç†æµ‹è¯•æ•°æ®</h2>
            <div class="test-controls">
                <button onclick="cleanupTestFiles()" class="error">æ¸…ç†æµ‹è¯•æ–‡ä»¶</button>
                <button onclick="cleanupMiniDBTest()" class="error">æ¸…ç†MiniDBæµ‹è¯•æ•°æ®</button>
                <button onclick="cleanupAllTestData()" class="error">æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®</button>
            </div>
            <div class="test-result" id="cleanup-result"></div>
        </div>
    </div>

    <script type="module">
        import { MiniDB } from "@lazycatcloud/minidb";
        
        // å…¨å±€å˜é‡
        window.miniDB = null;
        window.testCollections = {};
        window.testResults = {
            system: [],
            api: [],
            file: [],
            minidb: [],
            settings: [],
            comprehensive: []
        };
        
        // å·¥å…·å‡½æ•°
        function log(section, message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            const resultDiv = document.getElementById(`${section}-result`);
            if (resultDiv) {
                resultDiv.textContent += logMessage + '\n';
                resultDiv.scrollTop = resultDiv.scrollHeight;
            }
            
            console.log(logMessage);
            
            // ä¿å­˜åˆ°æµ‹è¯•ç»“æœ
            if (window.testResults[section]) {
                window.testResults[section].push({
                    timestamp,
                    message,
                    type
                });
            }
        }
        
        function updateStatus(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                const indicator = element.querySelector('.status-indicator');
                if (indicator) {
                    indicator.className = `status-indicator status-${status}`;
                }
            }
        }
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`/api${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                return { success: response.ok, data, status: response.status };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å‡½æ•°
        window.checkSystemHealth = async function() {
            log('system', 'å¼€å§‹ç³»ç»Ÿå¥åº·æ£€æŸ¥...');
            
            try {
                // æ£€æŸ¥åç«¯API
                const healthCheck = await apiCall('/health');
                if (healthCheck.success) {
                    log('system', 'âœ… åç«¯APIè¿æ¥æ­£å¸¸');
                    updateStatus('system-status', 'success');
                } else {
                    log('system', 'âŒ åç«¯APIè¿æ¥å¤±è´¥');
                    updateStatus('system-status', 'error');
                }
                
                // æ£€æŸ¥MiniDB
                try {
                    if (!window.miniDB) {
                        window.miniDB = new MiniDB();
                    }
                    log('system', 'âœ… MiniDBåˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    log('system', `âŒ MiniDBåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                }
                
                log('system', 'ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ');
            } catch (error) {
                log('system', `âŒ ç³»ç»Ÿæ£€æŸ¥å‡ºé”™: ${error.message}`);
            }
        };
        
        window.checkDirectories = async function() {
            log('system', 'æ£€æŸ¥ç›®å½•ç»“æ„...');
            
            const testResult = await apiCall('/test/file-write', {
                method: 'POST',
                body: JSON.stringify({
                    filename: 'directory_test',
                    content: 'Directory test content'
                })
            });
            
            if (testResult.success) {
                log('system', 'âœ… æ–‡ä»¶ç³»ç»Ÿå¯å†™');
            } else {
                log('system', 'âŒ æ–‡ä»¶ç³»ç»Ÿå†™å…¥å¤±è´¥');
            }
        };
        
        // åç«¯APIæµ‹è¯•å‡½æ•°
        window.testBackendHealth = async function() {
            log('api', 'æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥æ¥å£...');
            
            const result = await apiCall('/health');
            if (result.success) {
                log('api', `âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ${JSON.stringify(result.data, null, 2)}`);
            } else {
                log('api', `âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testInitData = async function() {
            log('api', 'æµ‹è¯•åˆå§‹åŒ–æ•°æ®æ¥å£...');
            
            const result = await apiCall('/init-data');
            if (result.success) {
                log('api', 'âœ… åˆå§‹åŒ–æ•°æ®è·å–æˆåŠŸ');
                log('api', `æ•°æ®åŒ…å«: ${Object.keys(result.data.data).join(', ')}`);
            } else {
                log('api', `âŒ åˆå§‹åŒ–æ•°æ®è·å–å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testSettings = async function() {
            log('api', 'æµ‹è¯•è®¾ç½®æ¥å£...');
            
            // è¯»å–è®¾ç½®
            const readResult = await apiCall('/settings');
            if (readResult.success) {
                log('api', 'âœ… è®¾ç½®è¯»å–æˆåŠŸ');
            } else {
                log('api', `âŒ è®¾ç½®è¯»å–å¤±è´¥: ${readResult.error}`);
            }
            
            // å†™å…¥è®¾ç½®
            const testSettings = {
                testMode: true,
                testTimestamp: new Date().toISOString()
            };
            
            const writeResult = await apiCall('/settings', {
                method: 'POST',
                body: JSON.stringify(testSettings)
            });
            
            if (writeResult.success) {
                log('api', 'âœ… è®¾ç½®å†™å…¥æˆåŠŸ');
            } else {
                log('api', `âŒ è®¾ç½®å†™å…¥å¤±è´¥: ${writeResult.error}`);
            }
        };
        
        // æ–‡ä»¶å­˜å‚¨æµ‹è¯•å‡½æ•°
        window.testFileWrite = async function() {
            const filename = document.getElementById('test-filename').value;
            const content = document.getElementById('test-content').value;
            
            log('file', `æµ‹è¯•æ–‡ä»¶å†™å…¥: ${filename}`);
            
            const result = await apiCall('/test/file-write', {
                method: 'POST',
                body: JSON.stringify({ filename, content })
            });
            
            if (result.success) {
                log('file', `âœ… æ–‡ä»¶å†™å…¥æˆåŠŸ: ${result.data.path}`);
            } else {
                log('file', `âŒ æ–‡ä»¶å†™å…¥å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testFileRead = async function() {
            const filename = document.getElementById('test-filename').value;
            
            log('file', `æµ‹è¯•æ–‡ä»¶è¯»å–: ${filename}`);
            
            const result = await apiCall(`/test/file-read/${filename}`);
            
            if (result.success) {
                log('file', `âœ… æ–‡ä»¶è¯»å–æˆåŠŸ: ${result.data.content}`);
            } else {
                log('file', `âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testDataSave = async function() {
            log('file', 'æµ‹è¯•JSONæ•°æ®ä¿å­˜...');
            
            const testData = {
                testId: 'test-001',
                name: 'Test Data',
                timestamp: new Date().toISOString(),
                items: ['item1', 'item2', 'item3']
            };
            
            const result = await apiCall('/save-data', {
                method: 'POST',
                body: JSON.stringify({
                    filename: 'test_data',
                    data: testData
                })
            });
            
            if (result.success) {
                log('file', 'âœ… JSONæ•°æ®ä¿å­˜æˆåŠŸ');
            } else {
                log('file', `âŒ JSONæ•°æ®ä¿å­˜å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testDataLoad = async function() {
            log('file', 'æµ‹è¯•JSONæ•°æ®åŠ è½½...');
            
            const result = await apiCall('/load-data/test_data');
            
            if (result.success) {
                log('file', 'âœ… JSONæ•°æ®åŠ è½½æˆåŠŸ');
                log('file', `æ•°æ®å†…å®¹: ${JSON.stringify(result.data.data, null, 2)}`);
            } else {
                log('file', `âŒ JSONæ•°æ®åŠ è½½å¤±è´¥: ${result.error}`);
            }
        };
        
        // MiniDBæµ‹è¯•å‡½æ•°
        window.testMiniDBConnection = async function() {
            log('minidb', 'æµ‹è¯•MiniDBè¿æ¥...');
            
            try {
                if (!window.miniDB) {
                    window.miniDB = new MiniDB();
                }
                
                const testCollection = window.miniDB.getCollection('test_connection');
                window.testCollections.connection = testCollection;
                
                log('minidb', 'âœ… MiniDBè¿æ¥æˆåŠŸ');
            } catch (error) {
                log('minidb', `âŒ MiniDBè¿æ¥å¤±è´¥: ${error.message}`);
            }
        };
        
        window.testMiniDBOperations = async function() {
            log('minidb', 'æµ‹è¯•MiniDBåŸºç¡€æ“ä½œ...');
            
            try {
                if (!window.miniDB) {
                    window.miniDB = new MiniDB();
                }
                
                const testCollection = window.miniDB.getCollection('test_operations');
                window.testCollections.operations = testCollection;
                
                // æ’å…¥æµ‹è¯•æ•°æ®
                const testDoc = {
                    testId: 'test-001',
                    name: 'Test Document',
                    value: 42,
                    timestamp: new Date().toISOString()
                };
                
                await testCollection.upsert(testDoc);
                log('minidb', 'âœ… æ•°æ®æ’å…¥æˆåŠŸ');
                
                // æŸ¥è¯¢æµ‹è¯•æ•°æ®
                const result = await testCollection.findOne({ testId: 'test-001' });
                if (result) {
                    log('minidb', 'âœ… æ•°æ®æŸ¥è¯¢æˆåŠŸ');
                    log('minidb', `æŸ¥è¯¢ç»“æœ: ${JSON.stringify(result, null, 2)}`);
                } else {
                    log('minidb', 'âŒ æ•°æ®æŸ¥è¯¢å¤±è´¥: æœªæ‰¾åˆ°æ•°æ®');
                }
                
            } catch (error) {
                log('minidb', `âŒ MiniDBæ“ä½œå¤±è´¥: ${error.message}`);
            }
        };
        
        window.testDataInitialization = async function() {
            log('minidb', 'æµ‹è¯•æ•°æ®åˆå§‹åŒ–...');
            
            try {
                // è·å–åˆå§‹åŒ–æ•°æ®
                const initResult = await apiCall('/init-data');
                if (!initResult.success) {
                    log('minidb', 'âŒ è·å–åˆå§‹åŒ–æ•°æ®å¤±è´¥');
                    return;
                }
                
                const initData = initResult.data.data;
                
                if (!window.miniDB) {
                    window.miniDB = new MiniDB();
                }
                
                // åˆå§‹åŒ–å„ä¸ªé›†åˆ
                const collections = {
                    formulas: window.miniDB.getCollection('formulas'),
                    models: window.miniDB.getCollection('models'),
                    snippets: window.miniDB.getCollection('snippets'),
                    tags: window.miniDB.getCollection('tags')
                };
                
                // æ’å…¥åˆå§‹åŒ–æ•°æ®
                for (const [collectionName, data] of Object.entries(initData)) {
                    if (collections[collectionName] && Array.isArray(data)) {
                        await collections[collectionName].upsert(data);
                        log('minidb', `âœ… ${collectionName} æ•°æ®åˆå§‹åŒ–æˆåŠŸ (${data.length} æ¡è®°å½•)`);
                    }
                }
                
                log('minidb', 'âœ… æ•°æ®åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                log('minidb', `âŒ æ•°æ®åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        };
        
        window.testMiniDBQueries = async function() {
            log('minidb', 'æµ‹è¯•MiniDBæŸ¥è¯¢åŠŸèƒ½...');
            
            try {
                if (!window.miniDB) {
                    window.miniDB = new MiniDB();
                }
                
                const modelsCollection = window.miniDB.getCollection('models');
                
                // æµ‹è¯•æŸ¥è¯¢æ‰€æœ‰æ•°æ®
                const allModels = await modelsCollection.find({}).fetch();
                log('minidb', `âœ… æŸ¥è¯¢æ‰€æœ‰æ¨¡å‹: ${allModels.length} æ¡è®°å½•`);
                
                // æµ‹è¯•æ¡ä»¶æŸ¥è¯¢
                const activeModels = await modelsCollection.find({ isActive: true }).fetch();
                log('minidb', `âœ… æŸ¥è¯¢æ´»è·ƒæ¨¡å‹: ${activeModels.length} æ¡è®°å½•`);
                
                // æµ‹è¯•æ’åºæŸ¥è¯¢
                const sortedModels = await modelsCollection.find({}, { sort: ['sortOrder'] }).fetch();
                log('minidb', `âœ… æ’åºæŸ¥è¯¢æˆåŠŸ: ${sortedModels.length} æ¡è®°å½•`);
                
            } catch (error) {
                log('minidb', `âŒ æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        };
        
        // è®¾ç½®ç®¡ç†æµ‹è¯•å‡½æ•°
        window.testSettingsRead = async function() {
            log('settings', 'æµ‹è¯•è®¾ç½®è¯»å–...');
            
            const result = await apiCall('/settings');
            if (result.success) {
                log('settings', 'âœ… è®¾ç½®è¯»å–æˆåŠŸ');
                log('settings', `å½“å‰è®¾ç½®: ${JSON.stringify(result.data.data, null, 2)}`);
            } else {
                log('settings', `âŒ è®¾ç½®è¯»å–å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testSettingsWrite = async function() {
            const key = document.getElementById('setting-key').value;
            const value = document.getElementById('setting-value').value;
            
            log('settings', `æµ‹è¯•è®¾ç½®å†™å…¥: ${key} = ${value}`);
            
            const testSettings = {
                [key]: value,
                testMode: true,
                lastTest: new Date().toISOString()
            };
            
            const result = await apiCall('/settings', {
                method: 'POST',
                body: JSON.stringify(testSettings)
            });
            
            if (result.success) {
                log('settings', 'âœ… è®¾ç½®å†™å…¥æˆåŠŸ');
            } else {
                log('settings', `âŒ è®¾ç½®å†™å…¥å¤±è´¥: ${result.error}`);
            }
        };
        
        window.testSettingsUpdate = async function() {
            log('settings', 'æµ‹è¯•è®¾ç½®æ›´æ–°...');
            
            // å…ˆè¯»å–å½“å‰è®¾ç½®
            const readResult = await apiCall('/settings');
            if (!readResult.success) {
                log('settings', 'âŒ æ— æ³•è¯»å–å½“å‰è®¾ç½®');
                return;
            }
            
            // æ›´æ–°è®¾ç½®
            const currentSettings = readResult.data.data;
            currentSettings.testCounter = (currentSettings.testCounter || 0) + 1;
            currentSettings.lastUpdate = new Date().toISOString();
            
            const updateResult = await apiCall('/settings', {
                method: 'POST',
                body: JSON.stringify(currentSettings)
            });
            
            if (updateResult.success) {
                log('settings', `âœ… è®¾ç½®æ›´æ–°æˆåŠŸ (è®¡æ•°å™¨: ${currentSettings.testCounter})`);
            } else {
                log('settings', `âŒ è®¾ç½®æ›´æ–°å¤±è´¥: ${updateResult.error}`);
            }
        };
        
        // ç»¼åˆæµ‹è¯•å‡½æ•°
        window.runFullTest = async function() {
            log('comprehensive', 'å¼€å§‹è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...');
            
            const tests = [
                { name: 'ç³»ç»Ÿå¥åº·æ£€æŸ¥', func: checkSystemHealth },
                { name: 'åç«¯APIæµ‹è¯•', func: testBackendHealth },
                { name: 'æ–‡ä»¶å­˜å‚¨æµ‹è¯•', func: testFileWrite },
                { name: 'MiniDBè¿æ¥æµ‹è¯•', func: testMiniDBConnection },
                { name: 'MiniDBæ“ä½œæµ‹è¯•', func: testMiniDBOperations },
                { name: 'æ•°æ®åˆå§‹åŒ–æµ‹è¯•', func: testDataInitialization },
                { name: 'è®¾ç½®ç®¡ç†æµ‹è¯•', func: testSettingsRead }
            ];
            
            let passedTests = 0;
            let totalTests = tests.length;
            
            for (const test of tests) {
                try {
                    log('comprehensive', `æ‰§è¡Œæµ‹è¯•: ${test.name}`);
                    await test.func();
                    passedTests++;
                    log('comprehensive', `âœ… ${test.name} é€šè¿‡`);
                } catch (error) {
                    log('comprehensive', `âŒ ${test.name} å¤±è´¥: ${error.message}`);
                }
                
                // æ·»åŠ å»¶è¿Ÿé¿å…è¿‡å¿«æ‰§è¡Œ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('comprehensive', `æµ‹è¯•å®Œæˆ: ${passedTests}/${totalTests} é€šè¿‡`);
            
            if (passedTests === totalTests) {
                log('comprehensive', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸');
            } else {
                log('comprehensive', 'âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½');
            }
        };
        
        window.testPerformance = async function() {
            log('comprehensive', 'å¼€å§‹æ€§èƒ½æµ‹è¯•...');
            
            const startTime = performance.now();
            
            try {
                // APIå“åº”æ—¶é—´æµ‹è¯•
                const apiStart = performance.now();
                await apiCall('/health');
                const apiTime = performance.now() - apiStart;
                log('comprehensive', `APIå“åº”æ—¶é—´: ${apiTime.toFixed(2)}ms`);
                
                // MiniDBæ“ä½œæ€§èƒ½æµ‹è¯•
                if (!window.miniDB) {
                    window.miniDB = new MiniDB();
                }
                
                const perfCollection = window.miniDB.getCollection('performance_test');
                
                const dbStart = performance.now();
                const testData = Array.from({ length: 100 }, (_, i) => ({
                    id: i,
                    name: `Test Item ${i}`,
                    timestamp: new Date().toISOString()
                }));
                
                await perfCollection.upsert(testData);
                const dbTime = performance.now() - dbStart;
                log('comprehensive', `MiniDBæ‰¹é‡æ’å…¥100æ¡è®°å½•è€—æ—¶: ${dbTime.toFixed(2)}ms`);
                
                // æŸ¥è¯¢æ€§èƒ½æµ‹è¯•
                const queryStart = performance.now();
                const results = await perfCollection.find({}).fetch();
                const queryTime = performance.now() - queryStart;
                log('comprehensive', `MiniDBæŸ¥è¯¢${results.length}æ¡è®°å½•è€—æ—¶: ${queryTime.toFixed(2)}ms`);
                
            } catch (error) {
                log('comprehensive', `âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
            
            const totalTime = performance.now() - startTime;
            log('comprehensive', `æ€§èƒ½æµ‹è¯•æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`);
        };
        
        window.generateTestReport = async function() {
            log('comprehensive', 'ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...');
            
            const report = {
                timestamp: new Date().toISOString(),
                testResults: window.testResults,
                summary: {
                    totalSections: Object.keys(window.testResults).length,
                    totalTests: Object.values(window.testResults).reduce((sum, tests) => sum + tests.length, 0)
                },
                environment: {
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    timestamp: new Date().toISOString()
                }
            };
            
            // ä¿å­˜æŠ¥å‘Šåˆ°åç«¯
            const saveResult = await apiCall('/save-data', {
                method: 'POST',
                body: JSON.stringify({
                    filename: `test_report_${Date.now()}`,
                    data: report
                })
            });
            
            if (saveResult.success) {
                log('comprehensive', 'âœ… æµ‹è¯•æŠ¥å‘Šå·²ä¿å­˜');
            } else {
                log('comprehensive', `âŒ æµ‹è¯•æŠ¥å‘Šä¿å­˜å¤±è´¥: ${saveResult.error}`);
            }
            
            log('comprehensive', `æµ‹è¯•æŠ¥å‘Šæ‘˜è¦: ${JSON.stringify(report.summary, null, 2)}`);
        };
        
        // æ¸…ç†å‡½æ•°
        window.cleanupTestFiles = async function() {
            log('cleanup', 'æ¸…ç†æµ‹è¯•æ–‡ä»¶...');
            
            const result = await apiCall('/test/cleanup', {
                method: 'DELETE'
            });
            
            if (result.success) {
                log('cleanup', `âœ… æµ‹è¯•æ–‡ä»¶æ¸…ç†æˆåŠŸ: ${result.data.message}`);
                log('cleanup', `æ¸…ç†çš„æ–‡ä»¶: ${result.data.cleanedFiles.join(', ')}`);
            } else {
                log('cleanup', `âŒ æµ‹è¯•æ–‡ä»¶æ¸…ç†å¤±è´¥: ${result.error}`);
            }
        };
        
        window.cleanupMiniDBTest = async function() {
            log('cleanup', 'æ¸…ç†MiniDBæµ‹è¯•æ•°æ®...');
            
            try {
                if (!window.miniDB) {
                    log('cleanup', 'âš ï¸ MiniDBæœªåˆå§‹åŒ–ï¼Œæ— éœ€æ¸…ç†');
                    return;
                }
                
                // æ¸…ç†æµ‹è¯•é›†åˆ
                const testCollectionNames = [
                    'test_connection',
                    'test_operations', 
                    'performance_test',
                    'formulas',
                    'models',
                    'snippets',
                    'tags'
                ];
                
                for (const collectionName of testCollectionNames) {
                    try {
                        await window.miniDB.removeCollection(collectionName);
                        log('cleanup', `âœ… æ¸…ç†é›†åˆ: ${collectionName}`);
                    } catch (error) {
                        log('cleanup', `âš ï¸ æ¸…ç†é›†åˆå¤±è´¥ ${collectionName}: ${error.message}`);
                    }
                }
                
                log('cleanup', 'âœ… MiniDBæµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ');
                
            } catch (error) {
                log('cleanup', `âŒ MiniDBæ¸…ç†å¤±è´¥: ${error.message}`);
            }
        };
        
        window.cleanupAllTestData = async function() {
            log('cleanup', 'å¼€å§‹æ¸…ç†æ‰€æœ‰æµ‹è¯•æ•°æ®...');
            
            // æ¸…ç†æ–‡ä»¶
            await cleanupTestFiles();
            
            // æ¸…ç†MiniDB
            await cleanupMiniDBTest();
            
            // é‡ç½®æµ‹è¯•ç»“æœ
            window.testResults = {
                system: [],
                api: [],
                file: [],
                minidb: [],
                settings: [],
                comprehensive: []
            };
            
            // æ¸…ç©ºæ˜¾ç¤ºåŒºåŸŸ
            const resultDivs = document.querySelectorAll('.test-result');
            resultDivs.forEach(div => {
                div.textContent = '';
            });
            
            log('cleanup', 'ğŸ§¹ æ‰€æœ‰æµ‹è¯•æ•°æ®æ¸…ç†å®Œæˆ');
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            log('system', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            setTimeout(checkSystemHealth, 1000);
        });
        
    </script>
</body>
</html>
