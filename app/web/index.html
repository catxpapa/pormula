<!-- index.html - åº”ç”¨ä¸»é¡µé¢ --> 
<!-- æä¾›ç”¨æˆ·ç•Œé¢å’Œä¸»è¦åŠŸèƒ½å…¥å£ --> 
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–µå’’Â·AI Spellbook</title>
    <link rel="stylesheet" href="/css/style.css">
    <script type="importmap">
    {
        "imports": {
            "@lazycatcloud/minidb": "https://cdn.skypack.dev/@lazycatcloud/minidb"
        }
    }
    </script>
</head>
<body>
    <div id="app-container" class="app-container">
        <div class="layout-main">
            <!-- å·¦ä¾§å¯¼èˆªæ  -->
            <div id="sidebar-container" class="layout-sidebar">
                <div class="p-lg">
                    <h2 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                        ğŸ± AI Spellbook
                    </h2>
                    <p class="text-center" style="color: var(--text-muted);">
                        ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
                    </p>
                </div>
            </div>
            
            <!-- ä¸»å†…å®¹åŒº -->
            <div id="main-content" class="layout-content">
                <div class="p-lg flex-center flex-column" style="flex: 1;">
                    <h1 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                        æ¬¢è¿ä½¿ç”¨ AI Spellbook
                    </h1>
                    <p style="color: var(--text-secondary); margin-bottom: var(--spacing-xl);">
                        AIæç¤ºè¯å…¬å¼ç»„åˆå·¥å…·
                    </p>
                    <div class="flex gap-md">
                        <a href="/test" class="button">
                            ğŸ§ª ç³»ç»Ÿæµ‹è¯•
                        </a>
                        <button class="button" onclick="initializeApp()">
                            ğŸš€ åˆå§‹åŒ–åº”ç”¨
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { MiniDB } from "@lazycatcloud/minidb";
        
        // å…¨å±€åº”ç”¨çŠ¶æ€
        window.app = {
            miniDB: null,
            collections: {},
            initialized: false
        };
        
        // åˆå§‹åŒ–åº”ç”¨
        window.initializeApp = async function() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            
            try {
                // åˆå§‹åŒ–MiniDB
                window.app.miniDB = new MiniDB();
                console.log('âœ… MiniDBåˆå§‹åŒ–æˆåŠŸ');
                
                // è·å–åˆå§‹åŒ–æ•°æ®
                const response = await fetch('/api/init-data');
                const result = await response.json();
                
                if (result.success) {
                    console.log('âœ… è·å–åˆå§‹åŒ–æ•°æ®æˆåŠŸ');
                    
                    // åˆå§‹åŒ–é›†åˆ
                    const collections = {
                        formulas: window.app.miniDB.getCollection('formulas'),
                        models: window.app.miniDB.getCollection('models'),
                        snippets: window.app.miniDB.getCollection('snippets'),
                        tags: window.app.miniDB.getCollection('tags')
                    };
                    
                    window.app.collections = collections;
                    
                    // å¯¼å…¥åˆå§‹åŒ–æ•°æ®
                    const initData = result.data;
                    for (const [collectionName, data] of Object.entries(initData)) {
                        if (collections[collectionName] && Array.isArray(data)) {
                            await collections[collectionName].upsert(data);
                            console.log(`âœ… ${collectionName} æ•°æ®å¯¼å…¥æˆåŠŸ (${data.length} æ¡)`);
                        }
                    }
                    
                    window.app.initialized = true;
                    console.log('ğŸ‰ åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
                    
                    // æ›´æ–°UI
                    updateUI();
                    
                } else {
                    throw new Error(result.error || 'è·å–åˆå§‹åŒ–æ•°æ®å¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                alert(`åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
            }
        };
        
        // æ›´æ–°UI
        function updateUI() {
            const sidebar = document.getElementById('sidebar-container');
            const mainContent = document.getElementById('main-content');
            
            if (window.app.initialized) {
                sidebar.innerHTML = `
                    <div class="p-lg">
                        <h2 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                            ğŸ± AI Spellbook
                        </h2>
                        <p style="color: var(--success-color);">âœ… ç³»ç»Ÿå·²å°±ç»ª</p>
                        <div class="mt-lg">
                            <p style="color: var(--text-secondary); font-size: 12px;">
                                æ­£å¼åŠŸèƒ½å¼€å‘ä¸­...
                            </p>
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = `
                    <div class="p-lg flex-center flex-column" style="flex: 1;">
                        <h1 style="color: var(--primary-color); margin-bottom: var(--spacing-lg);">
                            ğŸ‰ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
                        </h1>
                        <p style="color: var(--text-secondary); margin-bottom: var(--spacing-xl);">
                            æ‰€æœ‰åŸºç¡€åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥å¼€å§‹æ­£å¼å¼€å‘
                        </p>
                        <div class="flex gap-md">
                            <a href="/test" class="button">
                                ğŸ§ª æŸ¥çœ‹æµ‹è¯•é¡µé¢
                            </a>
                            <button class="button btn-success" onclick="showDataStatus()">
                                ğŸ“Š æŸ¥çœ‹æ•°æ®çŠ¶æ€
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // æ˜¾ç¤ºæ•°æ®çŠ¶æ€
        window.showDataStatus = async function() {
            try {
                const status = {};
                
                for (const [name, collection] of Object.entries(window.app.collections)) {
                    const data = await collection.find({}).fetch();
                    status[name] = data.length;
                }
                
                alert(`æ•°æ®çŠ¶æ€:\n${Object.entries(status).map(([name, count]) => `${name}: ${count} æ¡è®°å½•`).join('\n')}`);
                
            } catch (error) {
                alert(`è·å–æ•°æ®çŠ¶æ€å¤±è´¥: ${error.message}`);
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            if (window.innerWidth <= 768) {
                document.getElementById('app-container').classList.add('mobile');
            }
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function() {
                const container = document.getElementById('app-container');
                if (window.innerWidth <= 768) {
                    container.classList.add('mobile');
                } else {
                    container.classList.remove('mobile');
                }
            });
        });
    </script>
</body>
</html>
